<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerenciador de Obras</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
    }

    h1,
    h2 {
      color: #333;
    }

    form {
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      max-width: 400px;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    input,
    select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    button {
      margin-top: 15px;
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background: #45a049;
    }

    .mensagem {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
      color: white;
      display: none;
      max-width: 400px;
    }

    .mensagem.sucesso {
      background-color: #4CAF50;
    }

    .obra {
      background: white;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      transition: background 0.3s ease;
    }

    .obra.inicial {
      background-color: #f0f0f0;
    }

    .obra.andamento {
      background-color: #d0e7ff;
    }

    .obra.concluida {
      background-color: #d0ffd6;
    }

    .btn-excluir,
    .btn-editar {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      font-size: 14px;
    }

    .btn-editar {
      background: #2980b9;
    }

    .btn-excluir:hover {
      background: #c0392b;
    }

    .btn-editar:hover {
      background: #1f6391;
    }

    .barra {
      background: #ddd;
      width: 100%;
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progresso {
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }

    .progresso.inicial {
      background-color: gray;
    }

    .progresso.andamento {
      background-color: blue;
    }

    .progresso.concluida {
      background-color: green;
    }
  </style>
</head>

<body>

  <h1>Gerenciador de Obras</h1>

  <div id="mensagem" class="mensagem"></div>

  <h2>Cadastrar Nova Obra</h2>
  <form id="form-obra">
    <label for="nome">Nome da Obra:</label>
    <input type="text" id="nome" required />

    <label for="localizacao">Localização:</label>
    <input type="text" id="localizacao" required />

    <label for="orcamento">Orçamento (R$):</label>
    <input type="number" id="orcamento" step="0.01" min="0" required />

    <label for="responsavel">Responsável:</label>
    <input type="text" id="responsavel" placeholder="Opcional" />

    <label for="status">Status da Obra:</label>
    <select id="status">
      <option value="Inicial">Inicial</option>
      <option value="Em andamento">Em andamento</option>
      <option value="Concluída">Concluída</option>
    </select>

    <label for="progresso">Progresso (%):</label>
    <input type="number" id="progresso" min="0" max="100" value="0" required />

    <button type="submit">Cadastrar</button>
  </form>

  <h2>Obras Cadastradas</h2>
  <div id="lista-obras"></div>

  <script>
    const API_URL = "http://localhost:3000";
    const form = document.getElementById("form-obra");
    const listaObras = document.getElementById("lista-obras");
    const mensagemDiv = document.getElementById("mensagem");

    let obras = [];

    function mostrarMensagem(texto) {
      mensagemDiv.textContent = texto;
      mensagemDiv.style.display = "block";
      setTimeout(() => {
        mensagemDiv.style.display = "none";
      }, 2500);
    }

    function statusClasse(status) {
      if (status === "Inicial") return "inicial";
      if (status === "Em andamento") return "andamento";
      if (status === "Concluída") return "concluida";
      return "";
    }

    async function carregarObras() {
      try {
        const res = await fetch(`${API_URL}/obras`);
        if (!res.ok) throw new Error("Erro ao carregar obras");
        obras = await res.json();
        exibirObras();
      } catch (error) {
        alert(error.message);
      }
    }

    function exibirObras() {
      listaObras.innerHTML = "";

      if (obras.length === 0) {
        listaObras.innerHTML = "<p>Nenhuma obra cadastrada.</p>";
        return;
      }

      obras.forEach(obra => {
        const div = document.createElement("div");
        div.className = `obra ${statusClasse(obra.status)}`;

        div.innerHTML = `
        <h3>${obra.nome}</h3>
        <p><strong>Localização:</strong> ${obra.localizacao}</p>
        <p><strong>Orçamento:</strong> R$ ${parseFloat(obra.orcamento).toFixed(2)}</p>
        <p><strong>Responsável:</strong> ${obra.responsavel || "Não informado"}</p>
        <p><strong>Status:</strong> ${obra.status || "Inicial"}</p>
        <p><strong>Progresso:</strong> ${obra.progresso}%</p>
        <div class="barra"><div class="progresso ${statusClasse(obra.status)}" style="width: ${obra.progresso}%;"></div></div>
        <button class="btn-editar" onclick="editarObra(${obra.id})">Editar</button>
        <button class="btn-excluir" onclick="excluirObra(${obra.id})">Excluir</button>
        `;

        listaObras.appendChild(div);
      });
    }

    form.addEventListener("submit", async e => {
      e.preventDefault();

      const novaObra = {
        nome: form.nome.value.trim(),
        localizacao: form.localizacao.value.trim(),
        orcamento: parseFloat(form.orcamento.value),
        responsavel: form.responsavel.value.trim() || undefined,
        status: form.status.value,
        progresso: parseInt(form.progresso.value) || 0,
      };

      if (!novaObra.nome || !novaObra.localizacao || isNaN(novaObra.orcamento)) {
        alert("Preencha os campos obrigatórios corretamente.");
        return;
      }

      try {
        const res = await fetch(`${API_URL}/obras`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(novaObra),
        });

        if (!res.ok) {
          const erro = await res.json();
          throw new Error(erro.mensagem || "Erro ao cadastrar obra.");
        }

        const obraCriada = await res.json();
        obras.push(obraCriada);
        exibirObras();
        form.reset();
        mostrarMensagem("Obra cadastrada com sucesso!");
      } catch (error) {
        alert(error.message);
      }
    });

    async function excluirObra(id) {
      if (!confirm("Tem certeza que deseja excluir esta obra?")) return;
      try {
        const res = await fetch(`${API_URL}/obras/${id}`, { method: "DELETE" });
        if (!res.ok) throw new Error(`Erro ao excluir obra: ${res.status}`);
        obras = obras.filter(o => o.id !== id);
        exibirObras();
        mostrarMensagem("Obra excluída com sucesso!");
      } catch (error) {
        alert(error.message);
      }
    }

    async function editarObra(id) {
      const obra = obras.find(o => o.id === id);
      if (!obra) {
        alert("Obra não encontrada.");
        return;
      }

      const nome = prompt("Nome da Obra:", obra.nome);
      if (!nome) return;
      const localizacao = prompt("Localização:", obra.localizacao);
      if (!localizacao) return;
      const orcamento = parseFloat(prompt("Orçamento:", obra.orcamento));
      if (isNaN(orcamento)) return;
      const responsavel = prompt("Responsável (opcional):", obra.responsavel || "");
      const status = prompt("Status (Inicial, Em andamento, Concluída):", obra.status || "Inicial");
      const progresso = parseInt(prompt("Progresso (0-100):", obra.progresso));
      if (isNaN(progresso) || progresso < 0 || progresso > 100) return;

      try {
        const res = await fetch(`${API_URL}/obras/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nome, localizacao, orcamento, responsavel, status, progresso }),
        });

        if (!res.ok) {
          const erro = await res.json();
          throw new Error(erro.mensagem || "Erro ao editar obra.");
        }

        const obraAtualizada = await res.json();
        const index = obras.findIndex(o => o.id === id);
        if (index > -1) obras[index] = obraAtualizada;
        exibirObras();
        mostrarMensagem("Obra editada com sucesso!");
      } catch (error) {
        alert(error.message);
      }
    }

    carregarObras();
  </script>
</body>

</html>
