<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciador de Obras</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    h1, h2 {
      color: #333;
    }
    form, .obra {
      background: #fff;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      margin-top: 10px;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-editar { background: #2980b9; color: white; }
    .btn-excluir { background: #e74c3c; color: white; margin-left: 5px; }
    .btn-editar:hover { background: #1f6391; }
    .btn-excluir:hover { background: #c0392b; }
    .barra { background: #ddd; width: 100%; height: 20px; border-radius: 10px; overflow: hidden; margin-top: 5px; }
    .progresso { background: #4caf50; height: 100%; width: 0%; transition: width 0.3s ease; }
    .etapa, .material { background: #f0f0f0; padding: 8px; margin-top: 8px; border-radius: 4px; }
    .material { margin-left: 15px; }
  </style>
</head>
<body>

<h1>Gerenciador de Obras</h1>

<h2>Cadastrar Nova Obra</h2>
<form id="form-obra">
  <label>Nome da Obra:</label>
  <input type="text" id="nome" required>
  <label>Localização:</label>
  <input type="text" id="localizacao" required>
  <label>Responsável:</label>
  <input type="text" id="responsavel">
  <label>Status:</label>
  <select id="status">
    <option>Inicial</option>
    <option>Em andamento</option>
    <option>Concluída</option>
  </select>
  <label>Progresso (%):</label>
  <input type="number" id="progresso" min="0" max="100" value="0" required>
  <button type="submit">Cadastrar</button>
</form>

<h2>Obras Cadastradas</h2>
<div id="lista-obras"></div>

<script>
const API_URL = "http://localhost:3000";
let obras = [];

// ====================== FUNÇÕES ======================

// Carregar obras
async function carregarObras() {
  const res = await fetch(`${API_URL}/obras`);
  obras = await res.json();
  exibirObras();
}

// Exibir obras
function exibirObras() {
  const lista = document.getElementById("lista-obras");
  lista.innerHTML = "";
  if (obras.length === 0) {
    lista.innerHTML = "<p>Nenhuma obra cadastrada.</p>";
    return;
  }

  obras.forEach(obra => {
    const div = document.createElement("div");
    div.className = "obra";
    div.innerHTML = `
      <h3>${obra.nome}</h3>
      <p><strong>Localização:</strong> ${obra.localizacao}</p>
      <p><strong>Responsável:</strong> ${obra.responsavel || "Não informado"}</p>
      <p><strong>Status:</strong> ${obra.status}</p>
      <p><strong>Progresso:</strong> ${obra.progresso}%</p>
      <div class="barra"><div class="progresso" style="width:${obra.progresso}%"></div></div>
      <button class="btn-editar" onclick="editarObra(${obra.id})">Editar</button>
      <button class="btn-excluir" onclick="excluirObra(${obra.id})">Excluir</button>
      <h4>Etapas</h4>
      <div id="etapas-${obra.id}"></div>
      <button onclick="adicionarEtapa(${obra.id})">Adicionar Etapa</button>
    `;
    lista.appendChild(div);
    exibirEtapas(obra);
  });
}

// ====================== OBRAS ======================

document.getElementById("form-obra").addEventListener("submit", async e => {
  e.preventDefault();
  const novaObra = {
    nome: document.getElementById("nome").value,
    localizacao: document.getElementById("localizacao").value,
    responsavel: document.getElementById("responsavel").value,
    status: document.getElementById("status").value,
    progresso: parseInt(document.getElementById("progresso").value)
  };
  const res = await fetch(`${API_URL}/obras`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(novaObra)
  });
  const obraCriada = await res.json();
  obras.push(obraCriada);
  exibirObras();
  e.target.reset();
});

async function excluirObra(id) {
  if (!confirm("Tem certeza que deseja excluir esta obra?")) return;
  await fetch(`${API_URL}/obras/${id}`, { method: "DELETE" });
  obras = obras.filter(o => o.id !== id);
  exibirObras();
}

async function editarObra(id) {
  const obra = obras.find(o => o.id === id);
  if (!obra) return;

  const nome = prompt("Nome:", obra.nome) || obra.nome;
  const localizacao = prompt("Localização:", obra.localizacao) || obra.localizacao;
  const responsavel = prompt("Responsável:", obra.responsavel || "") || obra.responsavel;
  const status = prompt("Status:", obra.status) || obra.status;
  const progresso = parseInt(prompt("Progresso (0-100):", obra.progresso)) || obra.progresso;

  const res = await fetch(`${API_URL}/obras/${id}`, {
    method: "PUT",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({nome, localizacao, responsavel, status, progresso})
  });
  const obraAtualizada = await res.json();
  const index = obras.findIndex(o => o.id === id);
  obras[index] = obraAtualizada;
  exibirObras();
}

// ====================== ETAPAS ======================

function exibirEtapas(obra) {
  const div = document.getElementById(`etapas-${obra.id}`);
  div.innerHTML = "";
  obra.etapas.forEach(etapa => {
    const eDiv = document.createElement("div");
    eDiv.className = "etapa";
    eDiv.innerHTML = `
      <strong>${etapa.nome}</strong> (Status: ${etapa.status}, Prazo: ${etapa.prazo || "-"}) 
      <button onclick="editarEtapa(${obra.id},${etapa.id})">Editar</button>
      <button onclick="excluirEtapa(${obra.id},${etapa.id})">Excluir</button>
      <div id="materiais-${obra.id}-${etapa.id}"></div>
      <button onclick="adicionarMaterial(${obra.id},${etapa.id})">Adicionar Material</button>
    `;
    div.appendChild(eDiv);
    exibirMateriais(obra, etapa);
  });
}

async function adicionarEtapa(obraId) {
  const nome = prompt("Nome da etapa:");
  if (!nome) return;
  const status = prompt("Status da etapa: Inicial, Em andamento, Concluída") || "Inicial";
  const prazo = prompt("Prazo (opcional):") || null;

  const res = await fetch(`${API_URL}/obras/${obraId}/etapas`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({nome,status,prazo})
  });
  const etapa = await res.json();
  const obra = obras.find(o => o.id === obraId);
  obra.etapas.push(etapa);
  exibirEtapas(obra);
}

async function excluirEtapa(obraId, etapaId) {
  if (!confirm("Excluir etapa e todos os materiais?")) return;
  await fetch(`${API_URL}/obras/${obraId}/etapas/${etapaId}`, { method: "DELETE" });
  const obra = obras.find(o => o.id === obraId);
  obra.etapas = obra.etapas.filter(e => e.id !== etapaId);
  exibirEtapas(obra);
}

async function editarEtapa(obraId, etapaId) {
  const obra = obras.find(o => o.id === obraId);
  const etapa = obra.etapas.find(e => e.id === etapaId);
  const nome = prompt("Nome da etapa:", etapa.nome) || etapa.nome;
  const status = prompt("Status:", etapa.status) || etapa.status;
  const prazo = prompt("Prazo:", etapa.prazo || "") || etapa.prazo;

  const res = await fetch(`${API_URL}/obras/${obraId}/etapas/${etapaId}`, {
    method: "PUT",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({nome,status,prazo})
  });
  const etapaAtualizada = await res.json();
  const index = obra.etapas.findIndex(e => e.id === etapaId);
  obra.etapas[index] = etapaAtualizada;
  exibirEtapas(obra);
}

// ====================== MATERIAIS ======================

function exibirMateriais(obra, etapa) {
  const div = document.getElementById(`materiais-${obra.id}-${etapa.id}`);
  div.innerHTML = "";
  etapa.materiais.forEach(mat => {
    const mDiv = document.createElement("div");
    mDiv.className = "material";
    mDiv.innerHTML = `
      ${mat.nome} - Qtd: ${mat.quantidade} - Custo unit: R$${mat.custoUnit.toFixed(2)}
      <button onclick="excluirMaterial(${obra.id},${etapa.id},${mat.id})">Excluir</button>
    `;
    div.appendChild(mDiv);
  });
}

async function adicionarMaterial(obraId, etapaId) {
  const nome = prompt("Nome do material:");
  if (!nome) return;
  const quantidade = parseFloat(prompt("Quantidade:")) || 0;
  const custoUnit = parseFloat(prompt("Custo unitário:")) || 0;

  const res = await fetch(`${API_URL}/obras/${obraId}/etapas/${etapaId}/materiais`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({nome,quantidade,custoUnit})
  });
  const mat = await res.json();
  const obra = obras.find(o => o.id === obraId);
  const etapa = obra.etapas.find(e => e.id === etapaId);
  etapa.materiais.push(mat);
  exibirMateriais(obra, etapa);
}

async function excluirMaterial(obraId, etapaId, materialId) {
  if (!confirm("Excluir material?")) return;
  await fetch(`${API_URL}/obras/${obraId}/etapas/${etapaId}/materiais/${materialId}`, { method: "DELETE" });
  const obra = obras.find(o => o.id === obraId);
  const etapa = obra.etapas.find(e => e.id === etapaId);
  etapa.materiais = etapa.materiais.filter(m => m.id !== materialId);
  exibirMateriais(obra, etapa);
}

// ====================== INICIALIZAÇÃO ======================
carregarObras();
</script>

</body>
</html>
